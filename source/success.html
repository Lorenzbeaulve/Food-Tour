<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login effettuato</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div class="container map-layout">
        <div id="map-container">
            <div id="map"></div>
        </div>
        <aside id="sidebar">
            <div class="sidebar-header">
                <h2 id="sidebar-title">Dettagli ristorante</h2>
                <button id="sidebar-close" class="btn small">Chiudi</button>
            </div>
            <div id="sidebar-content" class="sidebar-content">
                <p>Seleziona un ristorante sulla mappa per vedere le informazioni qui.</p>
            </div>
        </aside>
    </div>

    <!-- Notes: replace YOUR_GOOGLE_MAPS_API_KEY with a valid API key -->
    <script>
        // Basic client-side map + sidebar logic
        let map, geocoder, infoWindow;

        function initMap(){
            geocoder = new google.maps.Geocoder();
            infoWindow = new google.maps.InfoWindow();

            // Geocode the city 'Vico Equense' to center the map
            geocoder.geocode({ address: 'Vico Equense, Italy' }, function(results, status){
                const center = (status === 'OK' && results[0]) ? results[0].geometry.location : { lat:40.60, lng:14.36 };
                map = new google.maps.Map(document.getElementById('map'), {
                    center: center,
                    zoom: 14,
                });

                // After map is ready, load restaurants
                loadRestaurants();
            });
        }

        // Fetch restaurants from backend and place markers
        async function loadRestaurants(){
            try{
                const res = await fetch('/api/restaurants');
                if(!res.ok) throw new Error('Failed to fetch restaurants');
                const data = await res.json();

                data.forEach(async (rest) => {
                    // If restaurant has lat/lng, use it; otherwise geocode the address
                    if(rest.lat && rest.lng){
                        placeMarker({lat: parseFloat(rest.lat), lng: parseFloat(rest.lng)}, rest);
                    }else if(rest.address){
                        try{
                            const geo = await geocodeAddress(rest.address);
                            if(geo) placeMarker(geo, rest);
                        }catch(e){
                            console.warn('Could not geocode', rest.address, e);
                        }
                    }
                });
            }catch(e){
                console.error('Error loading restaurants', e);
            }
        }

        function placeMarker(position, rest){
            const marker = new google.maps.Marker({ position, map, title: rest.name });
            marker.addListener('click', () => {
                const content = `<div style="min-width:200px;"><strong>${escapeHtml(rest.name || 'Ristorante')}</strong><br>${escapeHtml(rest.address||'')}</div>`;
                infoWindow.setContent(content);
                infoWindow.open(map, marker);
                openSidebar(rest);
            });
        }

        function geocodeAddress(address){
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address }, function(results, status){
                    if(status === 'OK' && results[0]){
                        const loc = results[0].geometry.location;
                        resolve({ lat: loc.lat(), lng: loc.lng() });
                    }else{
                        reject(status);
                    }
                });
            });
        }

        // Populate the sidebar with restaurant details and images
        function openSidebar(rest){
            const contentEl = document.getElementById('sidebar-content');
            contentEl.innerHTML = '';

            const title = document.createElement('h3');
            title.textContent = rest.name || 'Ristorante';
            contentEl.appendChild(title);

            if(rest.images && rest.images.length){
                const gallery = document.createElement('div');
                gallery.style.display = 'flex';
                gallery.style.gap = '0.5rem';
                gallery.style.flexWrap = 'wrap';
                rest.images.forEach(src=>{
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = rest.name || '';
                    img.style.width = '120px';
                    img.style.height = '80px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '6px';
                    img.style.cursor = 'pointer';
                    img.addEventListener('click', ()=>{ window.open(src, '_blank'); });
                    gallery.appendChild(img);
                });
                contentEl.appendChild(gallery);
            }

            if(rest.description){
                const p = document.createElement('p');
                p.style.marginTop = '0.6rem';
                p.textContent = rest.description;
                contentEl.appendChild(p);
            }

            const meta = document.createElement('div');
            meta.style.marginTop = '0.5rem';
            meta.innerHTML = `<strong>Indirizzo:</strong> ${escapeHtml(rest.address||'N/A')}<br>
                              <strong>Orari:</strong> ${escapeHtml(rest.open_time||'')} - ${escapeHtml(rest.close_time||'')}<br>`;
            contentEl.appendChild(meta);

            // additional info from DB
            if(rest.extra_info){
                const ex = document.createElement('div');
                ex.style.marginTop = '0.5rem';
                ex.textContent = rest.extra_info;
                contentEl.appendChild(ex);
            }
        }

        // Small helper to sanitize text
        function escapeHtml(str){
            if(!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Sidebar close button
        document.addEventListener('DOMContentLoaded', ()=>{
            document.getElementById('sidebar-close').addEventListener('click', ()=>{
                document.getElementById('sidebar-content').innerHTML = '<p>Seleziona un ristorante sulla mappa per vedere le informazioni qui.</p>';
            });
        });
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap"></script>
</body>
</html>
